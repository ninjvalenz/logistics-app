{% extends "base.html" %}

{% block title %}Tracking - Logistics App{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}

{% block content %}
<div>
    <h1 class="page-title">üì¶ Package Tracking</h1>
    <p class="page-subtitle">Track your shipments in real-time</p>

    <div class="tracking-search">
        <input 
            type="text" 
            class="search-input" 
            id="trackingInput"
            placeholder="Enter tracking number (e.g., SF-2024-12-23-001)"
            value="SF-2024-12-23-001"
        />
        <button class="btn" onclick="trackPackage()">Track Package</button>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Live Tracking</h2>
            <span class="status-badge in-transit">
                <span class="pulse">‚óè</span> In Transit
            </span>
        </div>
        <div id="map" class="map-container"></div>
    </div>

    <div class="card">
        <h2 class="card-title">Package Details</h2>
        <div class="package-info" id="packageInfo"></div>
    </div>

    <div class="card">
        <h2 class="card-title">Delivery Timeline</h2>
        <div class="timeline" id="timeline"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let map = null;
    let packageData = null;

    function initializeMap(data) {
        if (map) {
            map.remove();
        }

        map = L.map('map').setView([data.currentLocation.lat, data.currentLocation.lng], 12);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        const originIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background: #10b981; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div>',
            iconSize: [20, 20]
        });

        const destinationIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background: #ff6b35; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div>',
            iconSize: [20, 20]
        });

        const currentIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background: #ffa726; width: 24px; height: 24px; border-radius: 50%; border: 4px solid white; box-shadow: 0 4px 15px rgba(255,167,38,0.5); animation: pulse 2s infinite;"></div>',
            iconSize: [24, 24]
        });

        L.marker([data.origin.lat, data.origin.lng], { icon: originIcon })
            .addTo(map)
            .bindPopup(`<b>Origin:</b><br>${data.origin.name}`);

        L.marker([data.destination.lat, data.destination.lng], { icon: destinationIcon })
            .addTo(map)
            .bindPopup(`<b>Destination:</b><br>${data.destination.name}`);

        L.marker([data.currentLocation.lat, data.currentLocation.lng], { icon: currentIcon })
            .addTo(map)
            .bindPopup('<b>Current Location</b><br>Package in transit');

        const routeCoordinates = [
            [data.origin.lat, data.origin.lng],
            [data.currentLocation.lat, data.currentLocation.lng],
            [data.destination.lat, data.destination.lng]
        ];

        L.polyline(routeCoordinates, {
            color: '#ff6b35',
            weight: 3,
            opacity: 0.7,
            dashArray: '10, 10'
        }).addTo(map);
    }

    function updatePackageDetails(data) {
        const packageInfo = document.getElementById('packageInfo');
        packageInfo.innerHTML = `
            <div class="info-item">
                <div class="info-label">Tracking Number</div>
                <div class="info-value">${data.trackingNumber}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Recipient</div>
                <div class="info-value">${data.recipient}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Weight</div>
                <div class="info-value">${data.weight}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Est. Delivery</div>
                <div class="info-value">${data.estimatedDelivery}</div>
            </div>
        `;
    }

    function updateTimeline(data) {
        const timeline = document.getElementById('timeline');
        timeline.innerHTML = data.timeline.map(item => `
            <div class="timeline-item">
                <div class="timeline-dot ${item.completed ? 'completed' : ''}"></div>
                <div class="timeline-content">
                    <div class="timeline-time">${item.time}</div>
                    <div class="timeline-title">${item.status}</div>
                    <div class="timeline-location">${item.location}</div>
                </div>
            </div>
        `).join('');
    }

    function trackPackage() {
        const urlParams = new URLSearchParams(window.location.search);
        const trackingNumber = urlParams.get('tracking') || 'SF-2024-12-23-001';
        
        document.getElementById('trackingInput').value = trackingNumber;
        
        fetch('/api/packages')
            .then(response => response.json())
            .then(data => {
                packageData = data.find(pkg => pkg.trackingNumber === trackingNumber) || data[0];
                initializeMap(packageData);
                updatePackageDetails(packageData);
                updateTimeline(packageData);
            });
    }

    document.addEventListener('DOMContentLoaded', () => {
        trackPackage();
        
        document.querySelector('.btn').addEventListener('click', () => {
            const trackingNumber = document.getElementById('trackingInput').value;
            window.location.href = `/tracking?tracking=${trackingNumber}`;
        });
    });
</script>
{% endblock %}
